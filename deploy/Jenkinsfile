pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'bagisto-app'
        DOCKER_TAG = "${BUILD_NUMBER}"
        DEPLOY_ENV = 'staging'
    }

    stages {
        stage('Checkout & Setup') {
            steps {
                script {
                    // Checkout code
                    git branch: 'main',
                        credentialsId: 'GITHUB_PAT',
                        url: 'https://github.com/baotran1103/bagisto-app.git'

                    // Set build variables
                    env.GIT_COMMIT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    env.GIT_BRANCH = sh(script: 'git rev-parse --abbrev-ref HEAD', returnStdout: true).trim()

                    // Copy environment file
                    sh 'cp deploy/.env.staging .env'
                }
            }
        }

        stage('Security & Quality Checks') {
            parallel {
                stage('Code Quality') {
                    steps {
                        script {
                            try {
                                sh '''
                                    # Install dependencies for analysis
                                    composer install --no-interaction --no-progress --no-dev

                                    # Run PHPStan if configured
                                    if [ -f phpstan.neon ]; then
                                        ./vendor/bin/phpstan analyse --error-format=github
                                    fi

                                    # Run PHPCS
                                    if command -v phpcs >/dev/null 2>&1; then
                                        phpcs --standard=PSR12 app/ packages/Webkul/ || echo "PHPCS warnings found"
                                    fi
                                '''
                            } catch (Exception e) {
                                echo "‚ö†Ô∏è Code quality check failed: ${e.message}"
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }

                stage('Security Scan') {
                    steps {
                        script {
                            try {
                                sh '''
                                    # Composer audit
                                    composer audit --no-interaction || echo "‚ö†Ô∏è Composer security issues found"

                                    # NPM audit
                                    npm audit --audit-level=moderate || echo "‚ö†Ô∏è NPM security issues found"

                                    # ClamAV scan (if available)
                                    if command -v clamscan >/dev/null 2>&1; then
                                        clamscan --recursive --infected --exclude-dir=.git --exclude-dir=vendor --exclude-dir=node_modules . || echo "‚ö†Ô∏è Malware detected"
                                    fi
                                '''
                            } catch (Exception e) {
                                echo "‚ö†Ô∏è Security scan failed: ${e.message}"
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }

                stage('Unit Tests') {
                    steps {
                        script {
                            try {
                                sh '''
                                    # Install dependencies
                                    composer install --no-interaction --no-progress

                                    # Run tests
                                    ./vendor/bin/pest --stop-on-failure --coverage --min=70
                                '''
                            } catch (Exception e) {
                                echo "‚ùå Tests failed: ${e.message}"
                                currentBuild.result = 'FAILURE'
                                throw e
                            }
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                        # Build Docker image
                        docker build -f deploy/Dockerfile.prod -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest

                        # Save image for deployment
                        docker save ${DOCKER_IMAGE}:${DOCKER_TAG} > bagisto-app-${DOCKER_TAG}.tar
                    """
                }
            }
        }

        stage('Deploy to Staging') {
            steps {
                script {
                    sh '''
                        # Load Docker image
                        docker load < bagisto-app-${DOCKER_TAG}.tar

                        # Deploy using docker-compose
                        cd deploy
                        docker-compose -f docker-compose.staging.yml down
                        docker-compose -f docker-compose.staging.yml up -d

                        # Wait for services
                        sleep 30

                        # Run migrations
                        docker-compose -f docker-compose.staging.yml exec -T app php artisan migrate --force
                        docker-compose -f docker-compose.staging.yml exec -T app php artisan config:cache
                        docker-compose -f docker-compose.staging.yml exec -T app php artisan route:cache
                        docker-compose -f docker-compose.staging.yml exec -T app php artisan view:cache
                    '''
                }
            }
        }

        stage('Integration Tests') {
            steps {
                script {
                    try {
                        sh '''
                            # Wait for app to be ready
                            timeout 60 bash -c 'until curl -f http://localhost > /dev/null; do sleep 5; done'

                            # Run integration tests
                            docker-compose -f deploy/docker-compose.staging.yml exec -T app ./vendor/bin/pest tests/Feature/ --stop-on-failure

                            # Health check
                            curl -f http://localhost/health || exit 1
                        '''
                    } catch (Exception e) {
                        echo "‚ùå Integration tests failed: ${e.message}"
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
        }

        stage('Performance Test') {
            steps {
                script {
                    try {
                        sh '''
                            # Simple performance check
                            echo "Testing response time..."
                            time curl -s http://localhost > /dev/null

                            # Check resource usage
                            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" | head -10
                        '''
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Performance test warning: ${e.message}"
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                // Cleanup
                sh '''
                    # Remove old images
                    docker image prune -f

                    # Archive artifacts
                    mkdir -p artifacts
                    cp bagisto-app-${BUILD_NUMBER}.tar artifacts/ 2>/dev/null || true
                '''

                // Send notification
                echo "=== Build Summary ==="
                echo "Build: ${BUILD_NUMBER}"
                echo "Commit: ${GIT_COMMIT}"
                echo "Branch: ${GIT_BRANCH}"
                echo "Status: ${currentBuild.result ?: 'SUCCESS'}"
                echo "Duration: ${currentBuild.durationString}"
            }
        }

        success {
            script {
                echo "‚úÖ Staging deployment successful!"
                echo "üöÄ Application is ready at: http://your-staging-domain.com"

                // Optional: Send success notification
                sh '''
                    echo "Deployment completed successfully" > deployment_status.txt
                '''
            }
        }

        failure {
            script {
                echo "‚ùå Build failed! Check logs above."

                // Optional: Send failure notification
                sh '''
                    echo "Deployment failed" > deployment_status.txt
                '''
            }
        }

        unstable {
            script {
                echo "‚ö†Ô∏è Build completed with warnings"
            }
        }

        cleanup {
            script {
                // Clean workspace
                cleanWs(deleteDirs: true, disableDeferredWipeout: true, notFailBuild: true)
            }
        }
    }
}